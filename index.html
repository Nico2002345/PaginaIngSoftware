<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portafolio | Ingenier√≠a de Software</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1115; --muted:#9aa0a6; --text:#e5e7eb; --accent:#c7cad1; --accent-strong:#d9dbe1; --shadow:0 10px 25px rgba(0,0,0,.35); --radius:20px; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Montserrat',sans-serif; color:var(--text);
      background:
        linear-gradient(var(--bg), var(--bg)),
        repeating-linear-gradient(0deg, transparent, transparent 38px, rgba(255,255,255,0.04) 39px, transparent 40px),
        repeating-linear-gradient(90deg, transparent, transparent 38px, rgba(255,255,255,0.04) 39px, transparent 40px);
      background-attachment: fixed;
    }
    header{display:flex;align-items:center;gap:16px;padding:22px;border-bottom:1px solid rgba(255,255,255,.06)}
    .brand img{width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,.2);box-shadow:var(--shadow);background:#222;object-fit:cover}
    .brand h1{margin:0;font-size:22px;font-weight:800}
    .brand small{display:block;color:var(--muted)}
    nav{margin-left:auto;display:flex;gap:8px}
    .tab-btn{background:#1b2130;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .tab-btn.active{background:#2a3143}
    main{padding:28px}
    .card{background:#121621;border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:20px}
    .avatar{text-align:center}
    .avatar img{width:180px;height:180px;border-radius:50%;border:3px solid rgba(255,255,255,.18);box-shadow:var(--shadow);object-fit:cover}
    .tag{display:inline-block;padding:6px 10px;background:#1a2030;border:1px solid rgba(255,255,255,.08);border-radius:999px;font-size:12px}
    .hidden{display:none}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;align-items:center}
    .controls select,.controls input,.controls button{background:#0f1320;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:10px}
    .controls input[type="search"]{min-width:260px}
    details{background:#0f1320;border:1px solid rgba(255,255,255,.08);border-radius:14px;margin:10px 0;overflow:hidden}
    details>summary{cursor:pointer;padding:12px 16px;font-weight:700;list-style:none}
    details[open]>summary{background:#151b2a}
    .group-body{padding:0 16px 12px 16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:var(--accent-strong)}
    tr:hover{background:#141a27}
    .preview{min-height:300px;background:#0c1018;border-radius:12px;border:1px solid rgba(255,255,255,.06);display:grid;place-items:center;margin-top:12px;overflow:hidden}
    .btn{background:#2a3143;color:var(--text);padding:12px;border:none;border-radius:12px;cursor:pointer}
    footer{text-align:center;padding:20px;color:var(--muted)}
    .error{color:#f88;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="logoImg" alt="Logo del sitio">
    </div>
    <div>
      <h1>INGENIER√çA DE SOFTWARE</h1>
      <small>Soluciones inteligentes, resultados reales</small>
    </div>
    <nav aria-label="Secciones">
      <button class="tab-btn active" data-tab="quien">Qui√©n soy</button>
      <button class="tab-btn" data-tab="avance">Avance</button>
      <button class="tab-btn" data-tab="contacto">Cont√°cteme</button>
    </nav>
  </header>

  <main>
    <!-- QUI√âN SOY -->
    <section id="quien" aria-labelledby="titulo-quien">
      <div class="card avatar">
        <img id="fotoPerfil" alt="Foto de perfil">
        <h2 id="titulo-quien">Nicol√°s Calvo</h2>
        <p>Ingeniero en Sistemas</p>
        <span class="tag">Universidad Piloto de Colombia</span>
      </div>
    </section>

    <!-- AVANCE -->
    <section id="avance" class="hidden" aria-labelledby="titulo-avance">
      <div class="card">
        <h2 id="titulo-avance">Avance ¬∑ Documentos publicados</h2>

        <div class="controls" role="group" aria-label="Controles de filtrado y orden">
          <input id="q" type="search" placeholder="Buscar por nombre‚Ä¶" aria-label="Buscar por nombre">
          <label>Rango:
            <select id="range" aria-label="Rango de fechas">
              <option value="all" selected>Todos</option>
              <option value="today">Hoy</option>
              <option value="7d">√öltimos 7 d√≠as</option>
              <option value="month">Este mes</option>
              <option value="year">Este a√±o</option>
            </select>
          </label>
          <label>Orden:
            <select id="sort" aria-label="Orden">
              <option value="desc" selected>M√°s recientes primero</option>
              <option value="asc">M√°s antiguos primero</option>
            </select>
          </label>
          <button id="clear" class="btn" type="button">Limpiar</button>
        </div>

        <div id="doc-error" class="error"></div>
        <div id="groups" aria-live="polite"></div>
        <div class="preview" id="preview"><span style="color:#9aa0a6">Selecciona un archivo para previsualizarlo</span></div>

        <p style="color:#9aa0a6;margin-top:12px">
          Los documentos se listan desde <code>assets/docs/docs.json</code>.
        </p>
      </div>
    </section>

    <!-- CONTACTO -->
    <section id="contacto" class="hidden" aria-labelledby="titulo-contacto">
      <div class="card">
        <h2 id="titulo-contacto">Cont√°cteme</h2>
        <p><strong>Correo electr√≥nico:</strong> contacto.portafolio@example.com</p>
        <p><strong>Tel√©fono:</strong> +57 310 000 0000</p>
        <p><strong>Ubicaci√≥n:</strong> Bogot√° D.C., Colombia</p>
        <hr style="margin:16px 0; border: none; border-top: 1px solid rgba(255,255,255,.1)">
        <p style="color:#9aa0a6; font-size:14px">
          Esta es informaci√≥n de contacto ficticia. Sustit√∫yela por tus datos reales en el archivo <code>index.html</code> cuando quieras.
        </p>
      </div>
    </section>
  </main>

  <footer>¬© <span id="year"></span> Nicol√°s Calvo ¬∑ Ingenier√≠a de Software</footer>

  <script>
  // ---------------- Utilidades ----------------
  const errBox = document.getElementById('doc-error');
  const log = (...a)=>console.log('[portfolio]',...a);

  async function loadImgWithFallback(imgEl, candidates){
    for(const src of candidates){
      try{
        const r = await fetch(src, { method:'HEAD', cache:'no-store' });
        if(r.ok){ imgEl.src = src; return; }
      }catch{}
    }
    imgEl.alt += ' (no encontrada)';
  }

  const safeURL = (u='') => encodeURI(u.replace(/\s+\.(docx|xlsx|pptx|pdf|doc|xls|ppt|csv|txt|md|jpg|jpeg|png)$/i, '.$1'));
  const norm = (s='') => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  function typeLabel(m=''){ if(!m) return '‚Äî'; if(m.includes('wordprocessingml')) return 'Word (.docx)'; if(m.includes('spreadsheetml')) return 'Excel (.xlsx)'; if(m.includes('presentationml')) return 'PowerPoint (.pptx)'; if(m.startsWith('image/')) return 'Imagen'; if(m==='application/pdf') return 'PDF'; return m; }

  // ---------------- Tabs ----------------
  const tabs = document.querySelectorAll('.tab-btn');
  const sections = { quien: document.getElementById('quien'), avance: document.getElementById('avance'), contacto: document.getElementById('contacto') };
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(sections).forEach(s => s.classList.add('hidden'));
    sections[btn.dataset.tab].classList.remove('hidden');
  }));
  document.getElementById('year').textContent = new Date().getFullYear();

  loadImgWithFallback(document.getElementById('logoImg'),
    ['Logo.jpg','assets/logo.jpg','assets/Logo.jpg','logo.jpg','assets/logo.jpeg','logo.jpeg']);
  loadImgWithFallback(document.getElementById('fotoPerfil'),
    ['perfil.jpg','assets/perfil.jpg','assets/Perfil.jpg','Perfil.jpg','assets/perfil.jpeg','perfil.jpeg','Logo.jpg','assets/logo.jpg']);

  // ---------------- Avance / Explorador ----------------
  const groupsEl = document.getElementById('groups');
  const sortSel  = document.getElementById('sort');
  const rangeSel = document.getElementById('range');
  const qEl      = document.getElementById('q');
  const clearBtn = document.getElementById('clear');
  const preview  = document.getElementById('preview');
  let DOCS = [];

  const fmtDate = s => new Date(s).toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});

  // ‚úÖ Orden de fases con acentos tolerados
  const phaseOrder = ['Iniciaci√≥n','Estrategia','Requerimientos','Planeaci√≥n','Dise√±o','Implementaci√≥n','Pruebas','Postmortem','IniciacionYEstrategia','RequerimientosYPlaneaci√≥n','Dise√±oF2','Implementaci√≥nYPruebas','PostmortemF2'];

  // üîÑ Agrupa documentos por fase y a√±o/mes
  function groupByPhaseAndYM(items) {
  const map = {};
  for (const d of items) {
    const dt = new Date(d.date);
    if (isNaN(dt)) continue;
    const ym = dt.getFullYear() + "-" + String(dt.getMonth() + 1).padStart(2, '0');

    // üîπ Divide por coma si hay varias fases en el JSON
    const phases = (d.phase || 'Sin fase')
      .split(',')
      .map(p => p.trim())
      .filter(p => p);

    for (const phase of phases) {
      const normalizedPhase = norm(phase);
      const matchedPhase = phaseOrder.find(p => norm(p) === normalizedPhase) || phase;
      if (!map[matchedPhase]) map[matchedPhase] = {};
      if (!map[matchedPhase][ym]) map[matchedPhase][ym] = [];
      map[matchedPhase][ym].push(d);
    }
  }
  return map;
}

  function ymLabel(ym){ 
    const [y,m] = ym.split("-").map(Number); 
    const dt = new Date(y, m-1, 1); 
    return dt.toLocaleDateString(undefined, { year:'numeric', month:'long' }); 
  }

  function getQuickRange(){
    const now = new Date();
    const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const endOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime();
    switch(rangeSel.value){
      case 'today': return { f: today0.getTime(), t: endOfDay(today0) };
      case '7d': { const from = new Date(today0); from.setDate(from.getDate()-6); return { f: from.getTime(), t: endOfDay(today0) }; }
      case 'month': { const first = new Date(now.getFullYear(), now.getMonth(), 1); const last  = new Date(now.getFullYear(), now.getMonth()+1, 0); return { f: first.getTime(), t: endOfDay(last) }; }
      case 'year': { const first = new Date(now.getFullYear(), 0, 1); const last  = new Date(now.getFullYear(), 11, 31); return { f: first.getTime(), t: endOfDay(last) }; }
      default: return { f: -Infinity, t: Infinity };
    }
  }

  function render() {
    const order = sortSel.value;
    const query = norm(qEl.value.trim());
    const { f, t } = getQuickRange();

    const filtered = DOCS
      .filter(d => { 
        const ts = new Date(d.date).getTime(); 
        if(isNaN(ts)||ts<f||ts>t) return false; 
        if(query&&!d._nameN.includes(query)) return false; 
        return true; 
      })
      .sort((a,b)=> order==='desc' ? (new Date(b.date)-new Date(a.date)) : (new Date(a.date)-new Date(b.date)));

    const grouped = groupByPhaseAndYM(filtered);

    const phaseKeys = Object.keys(grouped).sort((a,b) => {
      const iA = phaseOrder.findIndex(p => norm(p) === norm(a));
      const iB = phaseOrder.findIndex(p => norm(p) === norm(b));
      if(iA!==-1 && iB!==-1) return iA - iB;
      if(iA!==-1) return -1;
      if(iB!==-1) return 1;
      return a.localeCompare(b);
    });

    let firstPhase = true;
    let html = '';

    for(const phase of phaseKeys){
      const phaseGroups = grouped[phase];
      const keys = Object.keys(phaseGroups).sort((a,b)=> order==='desc' ? (b.localeCompare(a)) : (a.localeCompare(b)));
      if(keys.length===0) continue;

      html += `<details ${firstPhase?'open':''}><summary style="font-weight:800">${phase}</summary>`;
      for(const ym of keys){
        const rows = phaseGroups[ym].map(d => {
          const urlSafe = safeURL(d.url || '');
          return `
            <tr data-url="${urlSafe}" data-type="${d.type || ''}">
              <td>${d.name || '‚Äî'}</td>
              <td>${typeLabel(d.type || '')}</td>
              <td>${fmtDate(d.date)}</td>
              <td><a href="${urlSafe}" target="_blank" rel="noopener">Abrir</a></td>
            </tr>
          `;
        }).join('');

        html += `
          <details ${firstPhase && keys[0]===ym ? 'open':''}>
            <summary>${ymLabel(ym)}</summary>
            <div class="group-body">
              <table>
                <thead><tr><th>Nombre</th><th>Tipo</th><th>Fecha</th><th>Abrir</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </details>
        `;
      }
      html += `</details>`;
      firstPhase = false;
    }

    if(!html) html = `<p style="color:#9aa0a6">No hay documentos para mostrar con el filtro actual.</p>`;
    groupsEl.innerHTML = html;

    groupsEl.querySelectorAll('tr[data-url]').forEach(tr => {
      tr.addEventListener('click', async (ev) => {
        if(ev.target.tagName.toLowerCase() === 'a') return;
        const url = tr.getAttribute('data-url');
        const type = tr.getAttribute('data-type') || "";
        try{ 
          const head = await fetch(url, { method:'HEAD' }); 
          if(!head.ok){ 
            preview.innerHTML = `<span class="error">No encontrado (HTTP ${head.status})<br><small>${url}</small></span>`; 
            return; 
          } 
        }catch{}
        showPreview(url, type);
      });
    });
  }

  async function showPreview(url, mime){
    if(!url) return;
    preview.innerHTML = "";
    const urlSafe = safeURL(url);
    if(mime && mime.startsWith("image/")){ const img = document.createElement('img'); img.src = urlSafe; img.style.maxWidth="100%"; img.style.height="auto"; preview.appendChild(img); return; }
    if(mime === "application/pdf"){ const iframe = document.createElement('iframe'); iframe.src = urlSafe; iframe.style.width="100%"; iframe.style.height="100%"; preview.appendChild(iframe); return; }
    if(mime && (mime.startsWith("text/") || mime==="text/markdown")){ try{ const res = await fetch(urlSafe); if(!res.ok) throw new Error('HTTP '+res.status); const txt = await res.text(); const pre = document.createElement('pre'); pre.textContent = txt; pre.style.padding="16px"; pre.style.whiteSpace="pre-wrap"; preview.appendChild(pre); }catch{ preview.innerHTML = `<span class="error">No se pudo cargar el texto.<br><small>${urlSafe}</small></span>`;} return; }
    preview.innerHTML = '<span style="color:#9aa0a6">Vista previa no disponible para este tipo. Usa ‚ÄúAbrir‚Äù.</span>';
  }

  rangeSel.addEventListener('change', render);
  qEl.addEventListener('input', render);
  sortSel.addEventListener('change', render);
  clearBtn.addEventListener('click', ()=>{ qEl.value=''; rangeSel.value='all'; sortSel.value='desc'; render(); });

  async function loadDocs(){
    try{
      const res = await fetch('assets/docs/docs.json');
      if(!res.ok) throw new Error('HTTP '+res.status);
      DOCS = await res.json();
      DOCS.forEach(d=>d._nameN=norm(d.name||''));
      render();
    }catch(err){
      errBox.textContent = 'No se pudo cargar docs.json: '+err.message;
    }
  }
  loadDocs();
</script>
</body>
</html>
